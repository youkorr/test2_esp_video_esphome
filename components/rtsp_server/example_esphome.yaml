# Example ESPHome configuration for RTSP Server with H.264
# Compatible with Frigate NVR

substitutions:
  device_name: esp32-p4-rtsp-camera
  friendly_name: "ESP32-P4 RTSP Camera"

esphome:
  name: ${device_name}
  friendly_name: ${friendly_name}
  platformio_options:
    board_build.flash_mode: qio
    board_build.mcu: esp32p4
    board_build.f_cpu: 400000000L

esp32:
  board: esp32-p4-function-ev-board
  variant: esp32p4
  framework:
    type: esp-idf
    version: latest
    sdkconfig_options:
      CONFIG_ESP32P4_REV_MIN_0: y
      CONFIG_SPIRAM: y
      CONFIG_SPIRAM_MODE_OCT: y
      CONFIG_SPIRAM_SPEED_200M: y
      CONFIG_CAMERA_SUPPORTED: y
      CONFIG_VIDEO_SUPPORTED: y

# WiFi
wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

  # Static IP recommended for Frigate
  manual_ip:
    static_ip: 192.168.1.150  # Change to your network
    gateway: 192.168.1.1
    subnet: 255.255.255.0

  ap:
    ssid: "${device_name} Fallback"
    password: "12345678"

# Enable logging
logger:
  level: INFO
  logs:
    rtsp_server: DEBUG

# Enable Home Assistant API
api:
  encryption:
    key: !secret api_encryption_key

# Enable OTA updates
ota:
  password: !secret ota_password

# I2C for camera sensor
i2c:
  - id: bsp_bus
    sda: GPIO14
    scl: GPIO13
    frequency: 400kHz

# MIPI-CSI Camera configuration
mipi_dsi_cam:
  id: main_camera
  i2c_id: bsp_bus

  # Camera sensor type (choose one)
  sensor_type: sc202cs  # or ov5647, ov02c10

  # Sensor pins
  xclk_pin: GPIO11
  xclk_freq: 24000000
  sensor_addr: 0x36
  reset_pin: GPIO26
  pwdn_pin: GPIO12

  # Video settings
  resolution: 720P       # VGA, 720P, 1080P, or WxH (e.g., 1280x720)
  pixel_format: RGB565   # Will be converted to YUV420 for H.264
  framerate: 30          # Frames per second

  # Optional: Image adjustments
  # brightness: 0
  # contrast: 0
  # saturation: 0
  # horizontal_mirror: false
  # vertical_flip: false

# RTSP Server for H.264 streaming
rtsp_server:
  camera_id: main_camera

  # RTSP server port (standard is 554)
  port: 554              # Use 8554 if running without root privileges

  # Stream path (URL will be rtsp://IP:554/stream)
  stream_path: "/stream"

  # RTP/RTCP ports for video streaming
  rtp_port: 5004         # RTP port for video data
  rtcp_port: 5005        # RTCP port for control

  # H.264 encoder settings
  bitrate: 2000000       # 2 Mbps (adjust for your network)
  gop: 30                # Group of Pictures (I-frame interval)
  qp_min: 10             # Min quantization (lower = better quality)
  qp_max: 40             # Max quantization (higher = more compression)

  # Max concurrent clients
  max_clients: 3         # Frigate + VLC + browser, etc.

# Optional: Status sensor
sensor:
  - platform: template
    name: "${friendly_name} Uptime"
    lambda: 'return millis() / 1000.0;'
    update_interval: 60s
    unit_of_measurement: "s"

  - platform: wifi_signal
    name: "${friendly_name} WiFi Signal"
    update_interval: 60s

# Optional: Status binary sensors
binary_sensor:
  - platform: status
    name: "${friendly_name} Status"

# Optional: Restart button
button:
  - platform: restart
    name: "${friendly_name} Restart"
